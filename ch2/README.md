# Chapter 2

## What is refactoring?

> **Refactoring** is a disciplined technique for restructuring an existing body of code, altering its internal structure without changing its external behavior.

리팩터링하는 동안에는 코드가 항상 정상 작동하기 때문에 전체 작업이 끝나지 않았더라도 언제든 멈출 수 있다.

> 누군가 "리팩터링하다가 코드가 깨져서 며칠이나 고생했다"라고 한다면, 십중팔구 리팩터링한 것이 아니다.

리팩터링의 목적은 코드를 이해하고 수정하기 쉽게 만드는 것이다. 프로그램의 성능은 좋아질 수도, 나빠질 수도 있다.

## Two hats

기능을 추가할 때는 '기능 추가' 모자를 쓴 다음 기존 코드는 절대 건드리지 않고 새 기능을 추가하기만 한다.
진척도는 테스트를 추가해서 통과하는지 확인하는 방식으로 측정한다.

반면 리팩터링할 때는 '리팩터링' 모자를 쓴 다음 기능 추가는 절대 하지 않기로 다짐한 뒤 오로지 리팩터링에만 전념한다.
테스트도 새로만들지 않고 부득이 인터페이스를 변경해야 할 때만 기존 테스트를 수정한다.

## Why refactoring is needed

- 소프트웨어 설계가 좋아진다
- 소프트웨어를 이해하기 쉬워진다
- 버그를 쉽게 찾을 수 있다
- 프로그래밍 속도를 높일 수 있다

## When to refactor

계획된 리팩터링과 수시로 하는 리팩터링.

> 보기 싫은 코드를 발견하면 리팩터링하자. 그런데 잘 작성된 코드 역시 수많은 리팩터링을 거쳐야 한다.

뛰어난 개발자는 새 기능을 추가하기 쉽도록 코드를 '수정'하는 것이 그 기능을 가장 빠르게 추가하는 길일 수 있음을 안다.

계획된 리팩터링을 최소로 줄이고 드러나지 않게, 기회가 될 때마다 하는 것이 좋다.

## When not to refactor

외부 API 다루듯 호출해서 사용하는 코드라면 지저분해도 그냥 둔다.(수정할 필요성 못느낄 경우)
내부 동작을 이해해야 할 시점에 리팩터링해야 효과를 제대로 볼 수 있다.

리팩터링하는 것보다 처음부터 새로 작성하는게 쉬울 때도 리팩터링하지 않는다.
그러나 리팩터링해보기 전에는 어느 쪽이 쉬운지 확실히 알 수 없을떄도 많다.

## Problems

리팩터링에도 딸려 오는 문제점이 있기 때문에 문제가 언제 발생하고 어떻게 대처해야 할지를 반드시 알고 있어야 한다.

리팩터링의 본질을 이해하지 못한 채 리팩터링으로 인해 새 기능 개발 속도가 저하된다고 생각하는 사람들이 많다.
개발팀을 이끌고 있다면 코드베이스가 더 건강해지는 것을 추구한다는 사실을 팀원들에게 명확히 밝혀야 한다.
리팩터링 할지 말지를 판단하는 능력은 수년에 걸친 경험을 통해 서서히 형성된다.
리더는 리팩터링 경험이 부족한 이들이 이런 능력을 빠르게 갖추도록 개발과정에서 많이 이끌어줘야 한다.

> 사람들이 빠지기 쉬운 가장 위험한 오류는 리팩터링을 **클린 코드** 나 '바람직한 엔지니어링 습관'처럼 도덕적인 이유로 정당화하는 것이다. 본질은 코드베이스를 예쁘게 꾸미는데 있는 것이 아니라 오로지 경제적인 이유에서 하는 것이다.

흔히 볼 수 있는 팀 단위 작업 방식은 버전 관리 시스템(git 등)을 사용하여 팀원마다 코드베이스의 브랜치를 하나씩 맡아 작업하다가 main 브랜치에 통합해 다른 팀원과 공유하는 것이다.
그러나 이 방법으로는 개인이 작업한 내용을 마스터에 통합하기 전까지는 다른 사람이 그 내용을 볼 수 없다.

Continuous Integration 방법으로 이 문제를 어느정도 해결할 수 있다.
CI는 리팩터링과 궁합이 아주 좋다.
CI를 완벽하게 적용하지는 못하더라도 코드를 통합하는 주기는 짧게 가져갈수록 좋다.

리팩터링하기 위해서는 self testing code를 마련해야 한다.
레거시 시스템을 테스트 코드없이 명료하게 리팩터링하기는 어렵다.

레거시 코드를 아름다운 코드로 단번에 리팩터링하는 것은 쉽지 않다.
서로 관련된 부분끼리 나눠서 Divide and Conquer를 하는 편이 낫다.
시스템의 규모가 크다면 자주 보는 부분을 더 많이 리팩터링한다.
코드를 훑게 되는 횟수가 많다는 말은 그 부분을 이해하기 쉽게 개선했을 때 얻는 효과도 그만큼 크다는 뜻이다.

## Refactoring and Performance

대부분 프로그램은 전체 코드 중 극히 일부에서 대부분의 시간을 소비한다. 
전체 코드를 최적화한다면 그중 90%는 효과가 거의 없기 때문에 최적화를 위해 투자한 시간을 낭비한 셈이다.

의도적으로 성능 최적화에 돌입하기 전까지는 성능에 신경쓰지 않고 코드를 다루기 쉽게 만드는데 집중한다.
그러다 성능 최적화 단계가 되면 아래와 같은 절차로 튜닝한다.

- Profiler로 프로그램을 분석하여 시간과 공간의 병목점을 찾아낸다
- 작은 단계로 나눠 차례로 최적화를 수행한다

리팩터링이 잘 되어있다면 성능 튜닝에 투입할 시간을 더 벌 수 있고, 프로그램을 더 세밀하게 분석할 수 있다.
단기적으로 보면 리팩터링 단계에서 성능이 느려질 수도 있다. 
하지만 최적화 단계에서 개선하기 쉬워지기 때문에 결국에는 더 빠른 소프트웨어를 얻게 된다.

