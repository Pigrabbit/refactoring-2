# Chapter 4

리팩터링을 제대로 하려면 불가피하게 저지르는 실수를 잡아주는 견고한 test suite가 뒷받침돼야 한다.
리팩터링을 하지 않더라도 좋은 테스트를 작성하는 일은 개발 효율을 높여준다.

## 자가 테스트의 가치

> Test suite는 강력한 버그 검출 도구로, 버그를 찾는 데 걸리는 시간을 대폭 줄여준다.

테스트가 프로그래밍 속도를 높여주는 경험을 직접해보지 않고서는 자가 테스트의 진가를 납득하기는 어렵다.

테스트를 작성하기 가장 좋은 시점은 프로그래밍을 시작하기 전이다. 
테스트를 작성하다 보면 원하는 기능을 추가하기 위해 무엇이 필요한지 고민하게 된다.
구현보다 인터페이스에 집중하게 된다는 장점도 있다.

**리팩터링에는 테스트가 필요하다. 그러니 리팩토링 하고 싶다면 테스트를 반드시 작성해야 한다.**

간혹 테스트가 갖춰지지 않은 코드를 리팩터링해야 할 때도 있다.
그럴 때는 곧바로 리팩터링하지 않고, 먼저 자가 테스트 코드부터 작성한다.

## Writing test suite

> 자주 테스트하라. 작성 중인 코드는 최소한 몇 분 간격으로 테스트하고, 적어도 하루에 한 번은 전체 테스트를 돌려보자.

테스트는 위험 요인을 중심으로 작성해야 한다.
테스트의 목적은 어디까지나 현재 혹은 향후에 발생할 수 있는 버그를 찾는 데 있다.

테스트를 너무 많이 만들다 보면 오히려 필요한 테스트를 놓치기 쉽다.
적은 수의 테스트로 잘못될까봐 가장 걱정되는 영역을 효율적으로 테스트하여 노력의 효과를 극대화한다.

개별 테스트를 실행할 때마다 fixture를 새로 만들면 모든 테스트를 독립적으로 구성할 수 있다.

실제 상황에서는 사용자가 값을 변경하면서 fixture의 내용도 수정되는 경우가 흔하다.

`beforeEach` block에서 설정한 표준 fixture를 취해서, 테스트를 수행하고 이 fixture가 일을 기대한 대로 처리했는지를 **검증**한다. (given-when-then)
이 3가지 단계가 한 테스트 안에 모두 담겨있을 수도 있고, 초기 준비 작업 중 공통되는 부분을 `beforeEach`와 같은 표준 설정 루틴에 모아서 처리하기도 한다.

`it` block 하나 당 검증을 하나만 하는 것이 좋다.
앞쪽 검증을 통과하지 못하면 나머지 검증은 실행해보지 못하고 테스트가 실패하기 때문에 실패원인을 파악하는데 유용한 정보를 놓치기 쉽다.

## Test boundary case

happy path(general case)를 벗어나는 boundary에서 문제가 생기면 어떤 일이 벌어지는지 확인하는 테스트도 함께 작성하면 좋다.

> 문제가 생길 가능성이 있는 경계 조건을 생각해보고 그 부분을 집중적으로 테스트하자.

> 어차피 모든 버그를 잡아낼 수는 없다고 생각하여 테스트를 작성하지 않는다면 대다수의 버그를 잡을 수 있는 기회를 날리는 셈이다.

테스트를 어느 수준까지 해야 할까?
테스트에도 **law of diminishing returns**가 적용된다.
따라서 테스트를 작성할 때는 위험한 부분에 집중하는게 좋다. (복잡한 부분, 함수에서 오류가 생길만한 부분을 찾아보자)

테스트가 모든 버그를 걸러주지는 못할지라도, 안심하고 리팩터링할 수 있는 보호막은 되어준다.
그리고 리팩터링을 하면서 프로그램을 더욱 깊이 이해하게 되어 더 많은 버그를 찾게 된다.

Test suite가 충분한지를 평가하는 기준은 주관적이다.
맆개터링 후 테스트 결과가 모두 초록색인 것만 보고도 리팩터링 과정에서 생겨난 버그가 하나도 없다고 확신할 수 있다면 충분히 좋은 test suite라고 할 수 있다.

테스트를 너무 많이 작성할 가능성도 있다.
제품 코드보다 테스트를 수정하는데 시간이 더 걸린다면, 그리고 테스트 때문에 개발 속도가 느려진다고 생각되면 테스트를 과하게 작성한 건 아닌지 의심해보자.
